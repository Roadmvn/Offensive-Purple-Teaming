# Windows Recon-Scanning – Beginner

La reconnaissance réseau sous Windows nécessite une approche adaptée aux spécificités de l'écosystème Microsoft. Ce guide présente les techniques fondamentales de découverte d'hôtes et d'énumération de services Windows en utilisant des outils natifs et des solutions tierces accessibles, permettant aux débutants de maîtriser l'identification des contrôleurs de domaine, des partages SMB et des services critiques de l'infrastructure Windows.

## Table of Contents
1. Concepts clés
2. Outils & Commandes
3. Méthode pas-à-pas
4. OPSEC Tips
5. Lab-Challenge
6. Going Further

---

### 1 • Concepts clés

#### 1.1 Architecture réseau Windows et Active Directory

L'environnement Windows repose sur une architecture centralisée autour d'Active Directory (AD) qui gère l'authentification, l'autorisation et la distribution des politiques de sécurité. La compréhension de cette architecture est cruciale pour une reconnaissance efficace, car elle détermine les cibles prioritaires et les vecteurs d'attaque potentiels.

Les contrôleurs de domaine (Domain Controllers) constituent les éléments centraux de l'infrastructure, hébergeant la base de données Active Directory et les services d'authentification Kerberos. L'identification de ces systèmes permet de comprendre la topologie du domaine et d'orienter les phases ultérieures de l'évaluation de sécurité.

#### 1.2 Protocoles et services Windows critiques

Les environnements Windows exposent des services spécifiques qui constituent des cibles privilégiées pour la reconnaissance. Le protocole SMB (Server Message Block) sur les ports 139 et 445 permet l'accès aux partages de fichiers et l'énumération des ressources réseau. Le service RDP (Remote Desktop Protocol) sur le port 3389 offre un accès distant aux systèmes Windows.

Les services d'authentification incluent Kerberos (port 88), LDAP (ports 389/636) et NetBIOS (ports 137-139) qui révèlent des informations sur la structure du domaine et les comptes utilisateurs. La compréhension de ces protocoles permet d'adapter les techniques de reconnaissance aux spécificités de l'environnement Windows.

#### 1.3 Énumération NetBIOS et découverte de domaines

NetBIOS (Network Basic Input/Output System) constitue un protocole fondamental pour la découverte d'hôtes Windows sur les réseaux locaux. Il permet l'identification des noms d'ordinateurs, des groupes de travail et des domaines sans authentification préalable. Cette information facilite la cartographie de l'infrastructure et l'identification des cibles prioritaires.

L'énumération NetBIOS révèle également les services actifs sur chaque système, incluant les serveurs de fichiers, les contrôleurs de domaine et les postes de travail. Cette approche passive permet de construire une vue d'ensemble de l'environnement avant d'approfondir l'analyse des services spécifiques.

#### 1.4 Gestion des permissions et partages Windows

Les systèmes Windows implémentent un modèle de permissions complexe basé sur les Access Control Lists (ACL) qui détermine l'accès aux ressources réseau. La reconnaissance des partages SMB permet d'identifier les ressources accessibles sans authentification ou avec des permissions mal configurées.

L'énumération des partages administratifs (C$, ADMIN$, IPC$) révèle les systèmes avec des configurations de sécurité faibles. L'analyse des permissions sur les partages utilisateur peut exposer des données sensibles ou des vecteurs d'escalade de privilèges pour les phases ultérieures du test de pénétration.


### 2 • Outils & Commandes

#### Tableau comparatif des outils Windows

| Outil | Usage principal | Disponibilité | Niveau de bruit | Efficacité |
|-------|----------------|---------------|-----------------|------------|
| ping | Test de connectivité | Natif Windows | Très faible | Élevée |
| net view | Énumération NetBIOS | Natif Windows | Faible | Moyenne |
| nbtstat | Information NetBIOS | Natif Windows | Faible | Élevée |
| nmap | Scan de ports universel | Installation requise | Configurable | Très élevée |
| telnet | Test de connectivité ports | Natif Windows | Faible | Moyenne |
| netsh | Configuration réseau | Natif Windows | Très faible | Moyenne |

#### Commandes natives Windows pour la découverte

```cmd
REM Test de connectivité de base
ping -n 4 192.168.1.1
```
Envoie 4 paquets ICMP vers la cible pour vérifier sa disponibilité et mesurer la latence réseau.

```cmd
REM Découverte des hôtes du domaine
net view /domain
```
Liste tous les domaines disponibles sur le réseau et les ordinateurs membres de chaque domaine.

```cmd
REM Énumération des ordinateurs du réseau local
net view
```
Affiche tous les ordinateurs Windows visibles sur le réseau local via NetBIOS.

```cmd
REM Information détaillée NetBIOS d'un hôte
nbtstat -A 192.168.1.100
```
Récupère les informations NetBIOS d'un hôte distant incluant le nom d'ordinateur et les services actifs.

```cmd
REM Découverte des partages d'un ordinateur
net view \\192.168.1.100
```
Liste tous les partages SMB disponibles sur l'ordinateur cible.

#### Commandes PowerShell pour la reconnaissance

```powershell
# Test de connectivité avancé avec PowerShell
Test-NetConnection -ComputerName 192.168.1.100 -Port 445
```
Teste la connectivité vers un port spécifique avec des informations détaillées sur la connexion.

```powershell
# Résolution DNS et énumération
Resolve-DnsName -Name 192.168.1.100
Get-DnsClientCache | Where-Object {$_.Entry -like "*192.168.1*"}
```
Effectue une résolution DNS inverse et examine le cache DNS local pour découvrir des noms d'hôtes.

```powershell
# Découverte des contrôleurs de domaine
nltest /dclist:domain.local
```
Identifie tous les contrôleurs de domaine dans le domaine spécifié.

```powershell
# Énumération des services réseau
Get-Service | Where-Object {$_.Status -eq "Running" -and $_.Name -like "*network*"}
```
Liste les services réseau actifs sur le système local pour comprendre les capacités disponibles.

#### Utilisation de Nmap sous Windows

```cmd
REM Scan de découverte réseau
nmap -sn 192.168.1.0/24
```
Effectue un scan de découverte d'hôtes sans scan de ports sur le sous-réseau spécifié.

```cmd
REM Scan des ports Windows critiques
nmap -p 135,139,445,3389 192.168.1.100
```
Scanne les ports essentiels des services Windows : RPC, NetBIOS, SMB et RDP.

```cmd
REM Scan avec détection d'OS Windows
nmap -O -p 445 192.168.1.100
```
Tente d'identifier la version de Windows en analysant les réponses du service SMB.

```cmd
REM Énumération SMB avec scripts Nmap
nmap --script smb-os-discovery -p 445 192.168.1.100
```
Utilise les scripts NSE pour extraire des informations détaillées sur le système d'exploitation Windows.

#### Outils de test de connectivité avancés

```cmd
REM Test de connectivité TCP avec telnet
telnet 192.168.1.100 80
```
Teste la connectivité vers un port TCP spécifique et permet l'interaction manuelle avec le service.

```cmd
REM Trace de route vers la cible
tracert 192.168.1.100
```
Identifie le chemin réseau vers la cible et révèle les équipements intermédiaires.

```cmd
REM Information sur les interfaces réseau locales
ipconfig /all
netsh interface show interface
```
Affiche la configuration réseau complète du système local pour comprendre la topologie.

```cmd
REM Analyse de la table de routage
route print
netsh interface ip show route
```
Examine les routes configurées pour identifier les réseaux accessibles et les passerelles.


### 3 • Méthode pas-à-pas

#### Étape 1 : Reconnaissance de l'environnement Windows local

Commencez par comprendre votre position dans l'infrastructure Windows et identifier les ressources réseau disponibles.

```cmd
REM Identification du domaine et de l'ordinateur local
echo %COMPUTERNAME%
echo %USERDOMAIN%
whoami /all
```
Identifiez votre contexte de sécurité actuel et votre appartenance au domaine.

```cmd
REM Découverte de la configuration réseau locale
ipconfig /all
netsh interface ip show config
```
Analysez la configuration réseau pour comprendre les sous-réseaux accessibles et les serveurs DNS.

```cmd
REM Énumération des domaines disponibles
net view /domain
nltest /domain_trusts
```
Découvrez tous les domaines accessibles et leurs relations de confiance.

#### Étape 2 : Découverte d'hôtes Windows sur le réseau

Utilisez les outils natifs Windows pour identifier les systèmes actifs avant d'approfondir l'analyse.

```cmd
REM Découverte des ordinateurs du domaine
net view /domain:DOMAIN_NAME
for /f "skip=1 tokens=1" %i in ('net view') do @ping -n 1 -w 1000 %i >nul && echo %i is alive
```
Énumérez tous les ordinateurs du domaine et testez leur connectivité.

```cmd
REM Scan de connectivité sur les ports Windows critiques
for /L %i in (1,1,254) do @(echo Testing 192.168.1.%i & telnet 192.168.1.%i 445 2>nul | find "Connected" && echo 192.168.1.%i:445 OPEN)
```
Testez la connectivité SMB sur une plage d'adresses IP pour identifier les systèmes Windows actifs.

```cmd
REM Énumération NetBIOS du réseau local
for /L %i in (1,1,254) do @nbtstat -A 192.168.1.%i 2>nul | find "NetBIOS" && echo 192.168.1.%i has NetBIOS
```
Identifiez tous les systèmes avec NetBIOS actif sur le réseau local.

#### Étape 3 : Énumération des services Windows critiques

Approfondissez l'analyse des systèmes découverts pour identifier les services et les vulnérabilités potentielles.

```cmd
REM Énumération des partages SMB
net view \\TARGET_IP
net use \\TARGET_IP\IPC$ "" /user:""
```
Tentez de vous connecter aux partages SMB avec des credentials vides pour identifier les configurations faibles.

```cmd
REM Test de connectivité RDP
nmap -p 3389 --script rdp-enum-encryption TARGET_IP
telnet TARGET_IP 3389
```
Vérifiez la disponibilité du service RDP et ses configurations de chiffrement.

```cmd
REM Identification des contrôleurs de domaine
nslookup -type=SRV _ldap._tcp.dc._msdcs.DOMAIN.LOCAL
nmap -p 88,389,636 TARGET_IP
```
Localisez les contrôleurs de domaine via DNS et vérifiez leurs services d'authentification.

#### Étape 4 : Utilisation de Nmap pour l'énumération Windows

Exploitez les capacités avancées de Nmap pour une reconnaissance détaillée des systèmes Windows.

```cmd
REM Scan complet des services Windows
nmap -sV -sC -p 135,139,445,3389,5985,5986 TARGET_IP
```
Effectuez un scan détaillé des ports Windows critiques avec détection de version et scripts par défaut.

```cmd
REM Énumération SMB avancée
nmap --script smb-enum-shares,smb-enum-users,smb-enum-domains -p 445 TARGET_IP
```
Utilisez les scripts NSE pour énumérer les partages, utilisateurs et domaines via SMB.

```cmd
REM Détection de vulnérabilités Windows courantes
nmap --script smb-vuln-* -p 445 TARGET_IP
```
Scannez les vulnérabilités SMB connues comme EternalBlue, MS08-067 et autres failles critiques.

#### Étape 5 : Documentation et analyse des résultats

Organisez et analysez les informations collectées pour identifier les cibles prioritaires.

```cmd
REM Sauvegarde des résultats de reconnaissance
echo %DATE% %TIME% - Début de la reconnaissance > recon_log.txt
net view >> recon_log.txt
nbtstat -c >> recon_log.txt
```
Documentez systématiquement toutes les découvertes avec horodatage pour traçabilité.

```cmd
REM Génération de rapports avec Nmap
nmap -sV -sC -oA windows_recon_report TARGET_RANGE
```
Créez des rapports structurés en multiple formats pour faciliter l'analyse ultérieure.

### 4 • OPSEC Tips

#### 4.1 Utilisation discrète des outils natifs Windows

Les outils natifs Windows génèrent moins de suspicion que les outils tiers car ils font partie de l'utilisation normale du système. Privilégiez net view, nbtstat et ping pour les phases initiales de reconnaissance. Ces commandes apparaissent rarement dans les alertes de sécurité et sont difficiles à distinguer de l'activité administrative légitime.

Évitez l'utilisation répétitive des mêmes commandes depuis le même poste. Variez les sources de scan et introduisez des délais aléatoires entre les requêtes pour simuler un comportement humain naturel. Les administrateurs système utilisent régulièrement ces outils, rendant votre activité indistinguable du trafic légitime.

#### 4.2 Gestion des logs d'authentification Windows

Les tentatives de connexion aux partages SMB génèrent des événements dans les logs de sécurité Windows (Event ID 4625 pour les échecs, 4624 pour les succès). Limitez les tentatives d'authentification et utilisez des comptes de service ou des comptes génériques pour réduire la visibilité. Évitez les attaques par force brute qui déclenchent immédiatement des alertes.

```cmd
REM Connexion discrète aux partages avec gestion d'erreurs
net use \\TARGET\IPC$ "" /user:"" 2>nul
if %errorlevel% equ 0 (echo Success) else (echo Failed - no retry)
```

Surveillez vos propres logs d'authentification pour comprendre les traces laissées par vos activités. Cette approche vous permet d'adapter vos techniques pour minimiser la génération d'événements suspects.

#### 4.3 Évitement des signatures de détection réseau

Les systèmes de détection d'intrusion analysent les patterns de trafic pour identifier les scans automatisés. Utilisez des délais variables entre les requêtes et limitez le nombre de connexions simultanées. Les scans séquentiels rapides constituent une signature évidente d'activité malveillante.

```cmd
REM Scan avec délais aléatoires pour éviter la détection
for /L %i in (1,1,254) do @(timeout /t %random:~-1% >nul & ping -n 1 192.168.1.%i >nul && echo 192.168.1.%i alive)
```

Alternez entre différentes techniques de découverte (NetBIOS, SMB, ICMP) pour éviter les signatures uniformes. Cette approche multicouche complique la détection par les systèmes automatisés tout en maintenant l'efficacité de la reconnaissance.

### 5 • Lab-Challenge

#### Scénario : Audit de sécurité d'un environnement Windows PME

Vous êtes consultant en cybersécurité chargé d'évaluer la sécurité d'une infrastructure Windows d'une PME de 150 employés. L'environnement comprend un domaine Active Directory (CORP.LOCAL), des serveurs de fichiers, des postes de travail Windows 10/11 et des serveurs d'applications métier. Votre accès initial se fait depuis un poste de travail Windows standard connecté au domaine.

L'entreprise souhaite identifier les vulnérabilités de configuration, les partages mal sécurisés et les services exposés inutilement. Votre mission consiste à effectuer une reconnaissance complète en utilisant principalement des outils natifs Windows pour minimiser la détection par les solutions de sécurité en place.

#### ⚑ Étape 1 : Découverte de l'infrastructure Active Directory

**Objectif :** Cartographier la structure du domaine et identifier les composants critiques de l'infrastructure.

**Questions :**
1. Identifiez tous les contrôleurs de domaine du domaine CORP.LOCAL et leurs adresses IP.
2. Découvrez tous les ordinateurs membres du domaine en utilisant uniquement des commandes natives Windows.
3. Listez les domaines de confiance et leurs relations avec CORP.LOCAL.
4. Identifiez les serveurs avec des rôles FSMO (Flexible Single Master Operations).

**Contraintes :**
- Utilisez uniquement les outils natifs Windows (net, nltest, nslookup, etc.)
- Documentez chaque commande utilisée et ses résultats
- Évitez les outils tiers pour cette phase initiale

#### ⚑ Étape 2 : Énumération des services et partages réseau

**Objectif :** Identifier les services Windows exposés et analyser les configurations de partages SMB.

**Questions :**
1. Découvrez tous les partages SMB accessibles sans authentification sur au moins 10 systèmes.
2. Identifiez 3 serveurs avec le service RDP activé et testez leurs configurations de chiffrement.
3. Localisez les serveurs de fichiers principaux et analysez leurs partages administratifs.
4. Trouvez au moins un service Windows non-standard sur un port inhabituel.

**Contraintes :**
- Testez la connectivité vers les ports 135, 139, 445, et 3389 sur tous les systèmes découverts
- Utilisez Nmap pour l'énumération détaillée des services
- Documentez les versions exactes des services Windows identifiés

#### ⚑ Étape 3 : Analyse de sécurité et détection de vulnérabilités

**Objectif :** Identifier les vulnérabilités de configuration et les faiblesses de sécurité dans l'environnement Windows.

**Questions :**
1. Utilisez les scripts NSE de Nmap pour détecter les vulnérabilités SMB sur tous les systèmes.
2. Identifiez les systèmes Windows avec des versions obsolètes ou non patchées.
3. Découvrez les partages avec des permissions de lecture/écriture pour "Everyone".
4. **Bonus stealth :** Effectuez toute la reconnaissance en utilisant uniquement des délais de 5+ secondes entre chaque requête.

**Livrables attendus :**
- Cartographie complète du domaine Active Directory avec tous les systèmes identifiés
- Liste détaillée des services Windows exposés avec leurs versions
- Rapport de vulnérabilités avec recommandations de durcissement
- Scripts batch documentés pour reproduire l'audit

### 6 • Going Further

#### Ressources officielles Microsoft et documentation

**Microsoft Security Compliance Toolkit** - https://www.microsoft.com/en-us/download/details.aspx?id=55319
Outils officiels Microsoft pour l'évaluation et le durcissement de la sécurité Windows avec guides de configuration sécurisée.

**Windows Security Baselines** - https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-security-baselines
Documentation officielle des configurations de sécurité recommandées pour les différentes versions de Windows.

**Active Directory Security Assessment** - https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/
Guide Microsoft pour l'évaluation de sécurité des environnements Active Directory avec méthodologies d'audit.

#### Ressources d'apprentissage spécialisées Windows

**"Windows Internals" par Mark Russinovich**
Référence technique approfondie sur le fonctionnement interne de Windows, essentielle pour comprendre les mécanismes de sécurité et les vecteurs d'attaque.

**"Active Directory Security" par Sean Metcalf**
Guide expert sur la sécurité Active Directory couvrant les techniques d'énumération, d'attaque et de défense des environnements Windows.

**Chaîne YouTube "13Cubed"** - https://www.youtube.com/c/13cubed
Tutoriels pratiques sur la forensique Windows et les techniques d'investigation incluant l'analyse des logs et des artefacts système.

**Cours "Windows Security" sur Pluralsight**
Formation complète sur la sécurisation des environnements Windows avec modules pratiques sur l'évaluation de sécurité.

#### Certifications et spécialisations Windows

**MCSA: Windows Server 2016**
Certification Microsoft validant les compétences d'administration Windows Server incluant la gestion de la sécurité et du monitoring.

**GCWN (GIAC Certified Windows Security Administrator)**
Certification SANS spécialisée dans la sécurisation et l'audit des environnements Windows avec focus sur Active Directory.

**OSCP (Offensive Security Certified Professional)**
Certification pratique incluant des modules spécialisés sur l'exploitation des vulnérabilités Windows et l'énumération Active Directory.

