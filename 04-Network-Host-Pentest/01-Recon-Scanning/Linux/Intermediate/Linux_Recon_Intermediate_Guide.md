# Linux Recon-Scanning – Intermediate

La reconnaissance réseau de niveau intermédiaire sous Linux intègre des techniques avancées d'énumération et d'analyse de vulnérabilités. Ce guide explore l'utilisation d'outils spécialisés comme Masscan pour les scans haute vitesse, l'exploitation des scripts NSE pour l'identification de vulnérabilités, et les méthodes de découverte UDP sophistiquées, permettant une évaluation approfondie des infrastructures complexes.

## Table of Contents
1. Concepts clés
2. Outils & Commandes
3. Méthode pas-à-pas
4. OPSEC Tips
5. Lab-Challenge
6. Going Further

---

### 1 • Concepts clés

#### 1.1 Optimisation des performances de scan

Les environnements réseau modernes nécessitent des approches de scan optimisées pour traiter efficacement de larges plages d'adresses IP. L'optimisation implique l'équilibrage entre vitesse, précision et discrétion. Les techniques incluent la parallélisation des requêtes, l'ajustement des timeouts et l'utilisation d'outils spécialisés comme Masscan pour les découvertes initiales rapides.

La segmentation des tâches permet de diviser les scans en phases distinctes : découverte d'hôtes, scan de ports, énumération de services et analyse de vulnérabilités. Cette approche modulaire optimise l'utilisation des ressources et facilite la gestion des résultats sur des infrastructures étendues.

#### 1.2 Scripts NSE et automatisation de l'énumération

Le Nmap Scripting Engine (NSE) fournit un framework puissant pour automatiser l'énumération et la détection de vulnérabilités. Les scripts NSE permettent d'identifier des configurations dangereuses, des services mal sécurisés et des vulnérabilités connues sans nécessiter d'outils externes.

L'utilisation stratégique des catégories de scripts (safe, intrusive, vuln, auth) permet d'adapter le niveau d'agressivité selon le contexte de l'engagement. Les scripts personnalisés peuvent être développés en Lua pour répondre à des besoins spécifiques d'énumération.

#### 1.3 Découverte et énumération UDP avancée

Les services UDP présentent des défis particuliers pour la reconnaissance en raison de leur nature sans connexion. Les techniques avancées incluent l'utilisation de payloads spécifiques pour provoquer des réponses, l'analyse des codes d'erreur ICMP et l'exploitation des caractéristiques protocolaires pour identifier les services actifs.

L'énumération UDP nécessite une compréhension approfondie des protocoles cibles (DNS, SNMP, DHCP, NTP) pour interpréter correctement les réponses et éviter les faux positifs. Les techniques de timing et de retry sont cruciales pour obtenir des résultats fiables.

#### 1.4 Corrélation et analyse des résultats

L'analyse intermédiaire nécessite la corrélation d'informations provenant de multiples sources pour construire une vue d'ensemble cohérente de l'infrastructure cible. Cette approche inclut la comparaison des résultats de différents outils, l'identification des patterns de configuration et la détection des anomalies de sécurité.

Les techniques de post-traitement permettent d'extraire des métriques significatives, d'identifier les services critiques et de prioriser les cibles pour les phases ultérieures du test de pénétration. L'utilisation d'outils de visualisation facilite l'interprétation des données complexes.


### 2 • Outils & Commandes

#### Tableau comparatif des outils intermédiaires

| Outil | Usage principal | Vitesse | Précision | Complexité |
|-------|----------------|---------|-----------|------------|
| masscan | Scan haute vitesse | Très élevée | Modérée | Moyenne |
| zmap | Scan Internet-scale | Très élevée | Élevée | Élevée |
| nmap + NSE | Énumération complète | Modérée | Très élevée | Moyenne |
| unicornscan | Scan asynchrone | Élevée | Élevée | Élevée |
| hping3 | Craft de paquets | Variable | Très élevée | Élevée |
| rustscan | Scan moderne rapide | Très élevée | Élevée | Faible |

#### Commandes Masscan pour la découverte rapide

```shell
# Scan ultra-rapide des ports courants
sudo masscan -p80,443,22,21,25,53,110,143,993,995 192.168.1.0/24 --rate=1000
```
Masscan excelle dans la découverte rapide de ports ouverts sur de larges plages réseau avec un débit configurable.

```shell
# Scan complet avec sauvegarde des résultats
sudo masscan -p1-65535 192.168.1.0/24 --rate=500 -oG masscan_results.gnmap
```
Effectue un scan complet de tous les ports TCP avec sauvegarde au format grepable pour post-traitement.

```shell
# Scan avec bannergrabbing basique
sudo masscan -p80,443 192.168.1.0/24 --rate=300 --banners
```
Combine la vitesse de Masscan avec la récupération de bannières pour identifier rapidement les services web.

```shell
# Scan UDP avec Masscan
sudo masscan -pU:53,161,123,69 192.168.1.0/24 --rate=100
```
Utilise Masscan pour la découverte UDP, particulièrement efficace pour les services sans état.

#### Scripts NSE pour l'énumération avancée

```shell
# Énumération SMB complète
nmap --script smb-enum-shares,smb-enum-users,smb-enum-domains,smb-enum-groups,smb-enum-services -p 445 192.168.1.100
```
Exécute une batterie de scripts SMB pour énumérer les partages, utilisateurs et services Windows.

```shell
# Détection de vulnérabilités courantes
nmap --script vuln -sV 192.168.1.100
```
Lance tous les scripts de détection de vulnérabilités pour identifier les failles de sécurité connues.

```shell
# Énumération HTTP avancée
nmap --script http-enum,http-headers,http-methods,http-robots.txt -p 80,443 192.168.1.100
```
Combine plusieurs scripts HTTP pour découvrir les répertoires, méthodes et configurations web.

```shell
# Scripts d'authentification et de brute force
nmap --script auth -p 21,22,23,25,110,143,993,995 192.168.1.100
```
Teste les mécanismes d'authentification et tente des attaques par dictionnaire sur les services identifiés.

#### Techniques de scan UDP sophistiquées

```shell
# Scan UDP avec payloads spécifiques
sudo nmap -sU --script=dns-service-discovery -p 53 192.168.1.0/24
```
Utilise des payloads DNS pour provoquer des réponses et confirmer la présence du service.

```shell
# Énumération SNMP complète
sudo nmap -sU -p 161 --script snmp-sysdescr,snmp-processes,snmp-netstat 192.168.1.0/24
```
Exploite SNMP pour extraire des informations système détaillées sur les équipements réseau.

```shell
# Découverte NTP et analyse temporelle
sudo nmap -sU -p 123 --script ntp-info,ntp-monlist 192.168.1.0/24
```
Énumère les serveurs NTP et exploite les vulnérabilités de réflexion pour l'amplification.

```shell
# Scan UDP avec timing optimisé
sudo nmap -sU --top-ports 100 -T4 --min-rate 1000 --max-retries 1 192.168.1.0/24
```
Optimise les paramètres de timing pour accélérer les scans UDP tout en maintenant la fiabilité.

#### Outils de post-traitement et analyse

```shell
# Conversion et analyse des résultats Masscan
masscan --readscan masscan_results.gnmap | grep "open" | awk '{print $4,$3}' | sort -u
```
Extrait et organise les ports ouverts découverts par Masscan pour analyse ultérieure.

```shell
# Génération de listes de cibles pour Nmap
masscan -p80,443 192.168.1.0/24 --rate=1000 | grep "open" | awk '{print $6}' | sort -u > web_targets.txt
```
Crée des listes de cibles spécialisées basées sur les résultats de découverte rapide.

```shell
# Corrélation multi-outils avec parsing
nmap -iL web_targets.txt -p 80,443 -sV --script http-title,http-server-header -oA detailed_web_scan
```
Utilise les résultats de Masscan comme input pour des scans Nmap détaillés et ciblés.


### 3 • Méthode pas-à-pas

#### Étape 1 : Reconnaissance préliminaire et planification

Avant d'initier des scans intensifs, établissez une stratégie basée sur la taille et la nature de l'infrastructure cible. Cette phase détermine les outils appropriés et les paramètres optimaux.

```shell
# Évaluation de la taille du réseau cible
ipcalc 192.168.1.0/24
echo "Nombre d'hôtes: $((2**(32-24)-2))"
```
Calculez le nombre d'hôtes potentiels pour dimensionner votre approche de scan.

```shell
# Test de connectivité et latence réseau
ping -c 10 192.168.1.1 | tail -1 | awk -F'/' '{print "RTT moyen: " $5 "ms"}'
```
Mesurez la latence réseau pour ajuster les timeouts et les paramètres de timing.

```shell
# Détection de filtrage et de protection réseau
sudo hping3 -S -p 80 -c 3 192.168.1.1
sudo hping3 -S -p 443 -c 3 192.168.1.1
```
Testez la réactivité du réseau avec des paquets SYN pour détecter d'éventuels systèmes de filtrage.

#### Étape 2 : Découverte rapide avec Masscan

Utilisez Masscan pour effectuer une découverte initiale rapide avant d'approfondir avec des outils plus précis.

```shell
# Scan de découverte ultra-rapide
sudo masscan -p1-1000 192.168.1.0/24 --rate=1000 --wait=2 -oG masscan_discovery.gnmap
```
Effectuez un scan rapide des 1000 premiers ports pour identifier les hôtes actifs et les services courants.

```shell
# Analyse des résultats et extraction des cibles
grep "open" masscan_discovery.gnmap | awk '{print $2}' | sort -u > active_hosts.txt
grep "open" masscan_discovery.gnmap | awk '{print $4}' | sort -u > open_ports.txt
```
Extrayez les hôtes actifs et les ports ouverts pour orienter les scans détaillés.

```shell
# Scan ciblé des ports intéressants
sudo masscan -p$(cat open_ports.txt | tr '\n' ',' | sed 's/,$//') 192.168.1.0/24 --rate=500 --banners -oG masscan_detailed.gnmap
```
Rescannez uniquement les ports découverts avec récupération de bannières pour optimiser l'efficacité.

#### Étape 3 : Énumération détaillée avec Nmap et NSE

Approfondissez l'analyse des cibles prometteuses identifiées lors de la phase de découverte rapide.

```shell
# Scan de version et scripts par défaut
nmap -iL active_hosts.txt -sV -sC --version-intensity 5 -oA nmap_detailed
```
Exécutez une énumération complète avec détection de version et scripts par défaut sur les hôtes actifs.

```shell
# Énumération spécialisée par service
nmap -iL active_hosts.txt -p 80,443 --script http-enum,http-headers,http-methods,http-title -oA web_enum
nmap -iL active_hosts.txt -p 21 --script ftp-anon,ftp-bounce,ftp-syst -oA ftp_enum
nmap -iL active_hosts.txt -p 22 --script ssh-hostkey,ssh-auth-methods -oA ssh_enum
```
Utilisez des scripts spécialisés pour chaque type de service découvert.

```shell
# Détection de vulnérabilités ciblée
nmap -iL active_hosts.txt --script vuln --script-args=unsafe=1 -oA vuln_scan
```
Lancez une détection de vulnérabilités complète incluant les scripts potentiellement intrusifs.

#### Étape 4 : Découverte et énumération UDP

Complétez l'analyse avec une découverte UDP méthodique des services critiques.

```shell
# Scan UDP des services essentiels
sudo nmap -sU -iL active_hosts.txt --top-ports 100 -sV --version-intensity 0 -oA udp_discovery
```
Scannez les ports UDP les plus courants avec détection de version légère pour éviter les timeouts.

```shell
# Énumération SNMP approfondie
sudo nmap -sU -p 161 -iL active_hosts.txt --script snmp-sysdescr,snmp-processes,snmp-interfaces,snmp-netstat -oA snmp_enum
```
Exploitez SNMP pour extraire des informations système détaillées sur les équipements réseau.

```shell
# Découverte DNS et énumération de zones
sudo nmap -sU -p 53 -iL active_hosts.txt --script dns-service-discovery,dns-zone-transfer -oA dns_enum
```
Testez les serveurs DNS pour les transferts de zone et la découverte de services.

#### Étape 5 : Optimisation des performances et timing

Ajustez les paramètres de scan pour optimiser l'équilibre entre vitesse et précision selon l'environnement.

```shell
# Scan avec timing adaptatif
nmap -iL active_hosts.txt -T4 --min-rate 100 --max-rate 1000 --max-retries 2 --host-timeout 300s -oA optimized_scan
```
Utilisez des paramètres de timing adaptatifs pour maintenir un débit constant tout en gérant les hôtes lents.

```shell
# Scan parallélisé par segments
split -l 50 active_hosts.txt segment_
for segment in segment_*; do
    nmap -iL $segment -sV -sC --max-hostgroup 10 -oA scan_$segment &
done
wait
```
Parallélisez les scans en divisant les cibles en segments pour accélérer le traitement.

```shell
# Monitoring des performances en temps réel
nmap -iL active_hosts.txt -sV --stats-every 30s --max-hostgroup 5 -v -oA monitored_scan
```
Surveillez les performances de scan en temps réel pour détecter les goulots d'étranglement.

#### Étape 6 : Corrélation et analyse des résultats

Consolidez et analysez les données collectées pour identifier les patterns et priorités.

```shell
# Fusion des résultats multiples
cat nmap_detailed.gnmap web_enum.gnmap ftp_enum.gnmap ssh_enum.gnmap > consolidated_results.gnmap
```
Combinez tous les résultats de scan pour une analyse globale.

```shell
# Extraction des services critiques
grep -E "(ssh|http|https|ftp|smtp|pop|imap)" consolidated_results.gnmap | awk '{print $2,$4,$5}' | sort -u > critical_services.txt
```
Identifiez et extrayez les services critiques pour prioriser les phases d'exploitation.

```shell
# Génération de métriques de sécurité
echo "=== Statistiques de découverte ==="
echo "Hôtes actifs: $(cat active_hosts.txt | wc -l)"
echo "Ports ouverts uniques: $(cat open_ports.txt | wc -l)"
echo "Services web: $(grep -c "80\|443" consolidated_results.gnmap)"
echo "Services SSH: $(grep -c "22" consolidated_results.gnmap)"
```
Générez des métriques quantitatives pour évaluer la surface d'attaque découverte.


### 4 • OPSEC Tips

#### 4.1 Gestion intelligente des débits et patterns de trafic

Les scans haute vitesse génèrent des patterns de trafic facilement détectables par les systèmes de monitoring réseau. L'utilisation de débits variables et de fenêtres temporelles aléatoires permet de simuler un trafic plus naturel. Implémentez des pauses dynamiques entre les requêtes et variez les sources de scan pour distribuer la charge.

```shell
# Scan avec débit adaptatif et randomisation
sudo masscan -p1-1000 192.168.1.0/24 --rate=100-500 --randomize-hosts --wait=5
```

Alternez entre différentes techniques de scan (TCP SYN, TCP Connect, UDP) pour éviter les signatures uniformes. Utilisez des scripts personnalisés pour introduire des délais aléatoires et des patterns de comportement humain dans vos séquences de reconnaissance.

#### 4.2 Évasion des systèmes de détection d'intrusion

Les IDS modernes analysent les patterns de scan pour identifier les outils automatisés. Combinez plusieurs techniques d'évasion : fragmentation de paquets, utilisation de decoy hosts, modification des TTL et randomisation des ports sources. Cette approche multicouche complique significativement la détection.

```shell
# Scan avec techniques d'évasion multiples
sudo nmap -sS -f -D 192.168.1.10,192.168.1.20,ME --source-port 53 --data-length 25 192.168.1.100
```

Exploitez les limitations des IDS en utilisant des techniques de timing sophistiquées. Les scans lents avec des intervalles irréguliers peuvent passer sous le seuil de détection de nombreux systèmes. Surveillez les réponses pour détecter d'éventuelles contre-mesures actives.

#### 4.3 Minimisation des traces dans les logs système

Comprenez les mécanismes de logging des systèmes cibles pour adapter vos techniques. Les connexions TCP complètes génèrent plus de logs que les scans SYN, les requêtes DNS peuvent être corrélées avec l'activité de scan, et les tentatives d'authentification échouées créent des alertes immédiates.

```shell
# Surveillance des logs locaux pendant les tests
sudo tail -f /var/log/syslog | grep -E "(nmap|masscan|scan)" &
MONITOR_PID=$!
# Effectuer les scans
kill $MONITOR_PID
```

Utilisez des proxies et des tunnels pour masquer votre adresse IP source. Implémentez des rotations d'adresses sources et exploitez les réseaux distribués pour diluer les traces. Considérez l'utilisation de VPN multiples et de chaînes de proxies pour les engagements sensibles.

### 5 • Lab-Challenge

#### Scénario : Audit de sécurité d'une infrastructure d'entreprise

Vous êtes pentester senior mandaté pour évaluer la sécurité d'une infrastructure d'entreprise de taille moyenne. L'organisation dispose de plusieurs sous-réseaux (192.168.10.0/24 pour les serveurs, 192.168.20.0/24 pour les postes de travail, 192.168.30.0/24 pour les équipements réseau) et souhaite une évaluation complète de sa surface d'attaque interne.

L'entreprise utilise une infrastructure mixte avec des serveurs Linux et Windows, des équipements réseau Cisco, et des services cloud hybrides. Votre mission consiste à identifier les vulnérabilités critiques, évaluer la segmentation réseau et proposer des recommandations de durcissement.

#### ⚑ Étape 1 : Découverte et cartographie multi-réseaux

**Objectif :** Effectuer une découverte complète des trois sous-réseaux en optimisant les performances et la discrétion.

**Questions :**
1. Utilisez Masscan pour découvrir tous les hôtes actifs sur les trois sous-réseaux en moins de 5 minutes.
2. Identifiez les 10 ports les plus fréquemment ouverts à travers l'infrastructure.
3. Déterminez quel sous-réseau présente la plus grande surface d'attaque (nombre de services exposés).
4. Créez une cartographie visuelle des services par sous-réseau.

**Contraintes :**
- Limitez le débit à 1000 pps maximum pour éviter la saturation réseau
- Documentez les temps de réponse par sous-réseau
- Sauvegardez tous les résultats en formats multiples (XML, gnmap, JSON)

#### ⚑ Étape 2 : Énumération avancée et détection de vulnérabilités

**Objectif :** Approfondir l'analyse des services critiques et identifier les vulnérabilités exploitables.

**Questions :**
1. Utilisez les scripts NSE pour énumérer tous les partages SMB accessibles sans authentification.
2. Identifiez au moins 3 services web et analysez leurs configurations de sécurité (headers, méthodes HTTP, répertoires).
3. Découvrez tous les services SNMP actifs et tentez d'extraire les informations système.
4. Détectez les vulnérabilités critiques (CVE) sur au moins 5 services différents.

**Contraintes :**
- Utilisez uniquement des scripts NSE "safe" pour éviter les perturbations
- Corréllez les résultats de multiple outils pour validation
- Documentez les versions exactes de tous les services critiques

#### ⚑ Étape 3 : Analyse UDP et services cachés

**Objectif :** Découvrir les services UDP critiques et identifier les services non-standard.

**Questions :**
1. Effectuez une découverte UDP complète et identifiez tous les serveurs DNS internes.
2. Localisez les services DHCP et analysez leurs configurations.
3. Découvrez des services sur des ports non-standard (>10000) en utilisant des techniques d'énumération avancées.
4. **Bonus stealth :** Implémentez une technique d'évasion personnalisée combinant fragmentation, decoy hosts et timing aléatoire.

**Livrables attendus :**
- Rapport exécutif avec cartographie réseau et recommandations prioritaires
- Base de données complète des services découverts avec niveaux de risque
- Scripts d'automatisation pour reproduire l'audit
- Preuves de concept pour les vulnérabilités critiques identifiées

### 6 • Going Further

#### Ressources officielles et documentation avancée

**Masscan Documentation** - https://github.com/robertdavidgraham/masscan
Documentation complète de Masscan avec exemples d'optimisation pour les scans haute performance et techniques d'évasion avancées.

**Nmap NSE Documentation** - https://nmap.org/nsedoc/
Référence exhaustive des scripts NSE avec exemples d'utilisation et guides de développement pour créer des scripts personnalisés.

**SANS Network Penetration Testing** - https://www.sans.org/cyber-security-courses/network-penetration-testing-ethical-hacking/
Cours avancé couvrant les méthodologies professionnelles de test de pénétration réseau avec focus sur les techniques d'évasion.

#### Ressources d'apprentissage spécialisées

**"Advanced Penetration Testing" par Wil Allsopp**
Guide expert couvrant les techniques avancées de reconnaissance réseau, l'évasion des systèmes de détection et l'automatisation des tests.

**"Network Security Assessment" 3rd Edition par Chris McNab**
Référence technique détaillant les méthodologies d'évaluation de sécurité pour les infrastructures complexes et les environnements distribués.

**Chaîne YouTube "The Cyber Mentor"** - https://www.youtube.com/c/TheCyberMentor
Tutoriels pratiques sur les techniques de reconnaissance avancées avec démonstrations sur des environnements réalistes.

**Cours "Advanced Network Attacks and Defenses" sur Pluralsight**
Formation spécialisée couvrant les techniques de reconnaissance sophistiquées et les contre-mesures de détection.

#### Certifications et spécialisations

**GPEN (GIAC Penetration Tester)**
Certification avancée validant les compétences en test de pénétration réseau avec emphasis sur les techniques de reconnaissance et d'évasion.

**OSCP (Offensive Security Certified Professional)**
Certification pratique exigeante nécessitant la maîtrise des techniques de reconnaissance avancées pour réussir l'examen hands-on.

**CISSP (Certified Information Systems Security Professional)**
Certification managériale incluant des modules sur l'évaluation de sécurité réseau et la gestion des risques cybersécurité.

