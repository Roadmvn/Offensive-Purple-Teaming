# macOS Recon-Scanning – Beginner

La reconnaissance réseau sous macOS exploite les spécificités de l'écosystème Apple et les protocoles de découverte automatique intégrés. Ce guide présente les techniques fondamentales de découverte d'hôtes sur les réseaux Apple, l'énumération des services Bonjour/mDNS, et l'utilisation des outils natifs macOS pour identifier les dispositifs iOS, macOS et les services réseau spécifiques à l'environnement Apple.

## Table of Contents
1. Concepts clés
2. Outils & Commandes
3. Méthode pas-à-pas
4. OPSEC Tips
5. Lab-Challenge
6. Going Further

---

### 1 • Concepts clés

#### 1.1 Écosystème réseau Apple et protocoles spécifiques

L'environnement réseau Apple repose sur des protocoles propriétaires et des standards ouverts adaptés pour l'interopérabilité entre dispositifs Apple. Le protocole Bonjour (implémentation Apple de Zeroconf) permet la découverte automatique de services sans configuration manuelle, utilisant mDNS (Multicast DNS) sur le port 5353 pour la résolution de noms et la publication de services.

Les réseaux Apple intègrent également des protocoles spécialisés comme AFP (Apple Filing Protocol) pour le partage de fichiers, AirPlay pour le streaming multimédia, et AirDrop pour le transfert de fichiers peer-to-peer. Cette richesse protocolaire offre de multiples vecteurs de reconnaissance spécifiques à l'écosystème Apple.

#### 1.2 Découverte mDNS et énumération Bonjour

Le protocole mDNS permet aux dispositifs Apple de s'annoncer automatiquement sur le réseau local sans serveur DNS centralisé. Chaque dispositif diffuse ses services disponibles via des requêtes multicast, créant une base de données distribuée des ressources réseau. Cette caractéristique facilite la découverte passive des dispositifs Apple et de leurs services.

L'énumération Bonjour révèle des informations détaillées sur les services exposés : imprimantes AirPrint, serveurs iTunes, dispositifs AirPlay, partages AFP et services personnalisés. Cette richesse d'information permet de cartographier précisément l'infrastructure Apple et d'identifier les points d'entrée potentiels.

#### 1.3 Spécificités de sécurité macOS et iOS

Les dispositifs Apple implémentent des mécanismes de sécurité spécifiques qui influencent les techniques de reconnaissance. Le System Integrity Protection (SIP) sur macOS limite l'accès aux ressources système, tandis que les restrictions de sandboxing affectent les capacités de scan. Les dispositifs iOS présentent des limitations encore plus strictes avec des restrictions réseau importantes.

La gestion des permissions macOS nécessite souvent des privilèges administrateur pour certaines opérations de reconnaissance, particulièrement pour l'accès aux interfaces réseau en mode promiscuous ou l'utilisation d'outils de scan avancés. Cette contrainte influence la stratégie de reconnaissance et nécessite une approche adaptée aux limitations du système.

#### 1.4 Intégration iCloud et services réseau Apple

Les dispositifs Apple s'intègrent étroitement avec les services iCloud, créant des connexions réseau vers les serveurs Apple qui peuvent révéler des informations sur l'infrastructure de l'organisation. Les services comme iCloud Drive, Photos, et la synchronisation de données génèrent un trafic réseau caractéristique identifiable lors de la reconnaissance.

L'analyse de ce trafic permet d'identifier les comptes Apple utilisés dans l'organisation, les services iCloud activés et potentiellement les données synchronisées. Cette information contextuelle enrichit la compréhension de l'environnement cible et peut révéler des vecteurs d'attaque spécifiques aux services cloud Apple.


### 2 • Outils & Commandes

#### Tableau comparatif des outils macOS

| Outil | Usage principal | Disponibilité | Niveau de bruit | Efficacité |
|-------|----------------|---------------|-----------------|------------|
| ping | Test de connectivité | Natif macOS | Très faible | Élevée |
| arp | Table ARP locale | Natif macOS | Très faible | Moyenne |
| dns-sd | Découverte Bonjour | Natif macOS | Faible | Très élevée |
| nmap | Scan de ports universel | Installation requise | Configurable | Très élevée |
| netstat | Connexions réseau | Natif macOS | Très faible | Moyenne |
| dscacheutil | Cache DNS | Natif macOS | Très faible | Faible |

#### Commandes natives macOS pour la découverte

```bash
# Test de connectivité de base
ping -c 4 192.168.1.1
```
Envoie 4 paquets ICMP vers la cible pour vérifier la connectivité et mesurer la latence réseau.

```bash
# Examen de la table ARP locale
arp -a
arp -a | grep -E "([0-9]{1,3}\.){3}[0-9]{1,3}"
```
Affiche toutes les entrées ARP connues, révélant les hôtes récemment contactés sur le réseau local.

```bash
# Découverte des services Bonjour/mDNS
dns-sd -B _services._dns-sd._udp local.
```
Énumère tous les types de services Bonjour disponibles sur le réseau local.

```bash
# Recherche de services spécifiques
dns-sd -B _http._tcp local.
dns-sd -B _afpovertcp._tcp local.
dns-sd -B _airplay._tcp local.
```
Découvre les serveurs web, partages AFP et dispositifs AirPlay sur le réseau.

#### Énumération mDNS et services Apple

```bash
# Découverte complète des services mDNS
for service in _http._tcp _https._tcp _ftp._tcp _afpovertcp._tcp _smb._tcp _airplay._tcp _raop._tcp _printer._tcp _ipp._tcp; do
    echo "=== Recherche $service ==="
    dns-sd -B $service local.
    sleep 2
done
```
Énumère systématiquement tous les services Apple courants via mDNS.

```bash
# Résolution détaillée des services découverts
dns-sd -L "Service Name" _http._tcp local.
```
Obtient les détails complets d'un service spécifique incluant l'adresse IP et le port.

```bash
# Découverte des imprimantes AirPrint
dns-sd -B _ipp._tcp local.
dns-sd -B _printer._tcp local.
```
Identifie toutes les imprimantes compatibles AirPrint sur le réseau.

```bash
# Énumération des dispositifs AirPlay
dns-sd -B _airplay._tcp local.
dns-sd -B _raop._tcp local.
```
Découvre les Apple TV, haut-parleurs AirPlay et autres dispositifs de streaming.

#### Commandes réseau macOS avancées

```bash
# Analyse des interfaces réseau
ifconfig -a
networksetup -listallhardwareports
```
Liste toutes les interfaces réseau disponibles et leur configuration.

```bash
# Examen des connexions actives
netstat -an | grep ESTABLISHED
lsof -i -P | grep LISTEN
```
Affiche les connexions réseau établies et les services en écoute sur le système local.

```bash
# Analyse du cache DNS
dscacheutil -q host -a name google.com
sudo dscacheutil -flushcache
```
Interroge le cache DNS local et peut le vider pour forcer de nouvelles résolutions.

```bash
# Découverte des routes réseau
netstat -rn
route -n get default
```
Examine la table de routage pour comprendre la topologie réseau.

#### Utilisation de Nmap sous macOS

```bash
# Installation de Nmap via Homebrew
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
brew install nmap
```
Installe Nmap sur macOS via le gestionnaire de paquets Homebrew.

```bash
# Scan de découverte réseau
nmap -sn 192.168.1.0/24
```
Effectue un scan de découverte d'hôtes sans scan de ports sur le sous-réseau.

```bash
# Scan des ports Apple spécifiques
nmap -p 22,80,443,548,5353,62078 192.168.1.100
```
Scanne les ports couramment utilisés par les services Apple : SSH, HTTP, HTTPS, AFP, mDNS et AirPlay.

```bash
# Détection d'OS Apple avec Nmap
nmap -O -p 22,80,443 192.168.1.100
```
Tente d'identifier la version de macOS ou iOS en analysant les réponses réseau.

### 3 • Méthode pas-à-pas

#### Étape 1 : Reconnaissance de l'environnement réseau local

Commencez par comprendre votre position dans le réseau Apple et identifier les ressources disponibles.

```bash
# Identification de la configuration réseau locale
ifconfig en0
networksetup -getinfo "Wi-Fi"
scutil --get ComputerName
```
Identifiez votre interface réseau active, sa configuration et le nom de votre Mac.

```bash
# Découverte de la passerelle et des serveurs DNS
route -n get default
scutil --dns | grep nameserver
```
Identifiez la passerelle par défaut et les serveurs DNS configurés.

```bash
# Test de connectivité vers les services Apple
ping -c 3 apple.com
ping -c 3 icloud.com
```
Vérifiez la connectivité vers les services Apple pour confirmer l'accès Internet.

#### Étape 2 : Découverte passive via mDNS et Bonjour

Utilisez les protocoles Apple natifs pour découvrir les dispositifs et services sans générer de trafic suspect.

```bash
# Énumération complète des services Bonjour
echo "=== Découverte des services Bonjour ==="
dns-sd -B _services._dns-sd._udp local. | head -20

# Attendre quelques secondes pour la découverte
sleep 5

# Énumération des services spécifiques
services=("_http._tcp" "_https._tcp" "_afpovertcp._tcp" "_smb._tcp" "_airplay._tcp" "_printer._tcp")
for service in "${services[@]}"; do
    echo "=== Service $service ==="
    timeout 10 dns-sd -B $service local.
done
```

#### Étape 3 : Analyse de la table ARP et découverte d'hôtes

Exploitez les informations locales pour identifier les hôtes actifs avant d'initier des scans actifs.

```bash
# Analyse détaillée de la table ARP
arp -a | while read line; do
    ip=$(echo $line | grep -oE '([0-9]{1,3}\.){3}[0-9]{1,3}')
    mac=$(echo $line | grep -oE '([0-9a-f]{2}:){5}[0-9a-f]{2}')
    if [[ ! -z "$ip" && ! -z "$mac" ]]; then
        echo "IP: $ip - MAC: $mac"
        # Test de connectivité
        ping -c 1 -W 1000 $ip > /dev/null 2>&1 && echo "  -> Actif" || echo "  -> Inactif"
    fi
done
```

#### Étape 4 : Scan de ports ciblé sur les dispositifs Apple

Approfondissez l'analyse des hôtes découverts en vous concentrant sur les services Apple.

```bash
# Fonction de scan des ports Apple
scan_apple_ports() {
    local target=$1
    local ports="22,80,443,548,5353,62078,88,389,636"
    
    echo "=== Scan de $target ==="
    nmap -p $ports $target
    
    # Test spécifique des services Apple
    echo "=== Tests de services Apple ==="
    
    # Test AFP
    nc -z $target 548 && echo "AFP disponible sur $target"
    
    # Test mDNS
    nc -z -u $target 5353 && echo "mDNS disponible sur $target"
    
    # Test AirPlay
    nc -z $target 62078 && echo "AirPlay disponible sur $target"
}

# Application sur les hôtes découverts
arp -a | grep -oE '([0-9]{1,3}\.){3}[0-9]{1,3}' | while read ip; do
    scan_apple_ports $ip
done
```

#### Étape 5 : Énumération des services découverts

Analysez en détail les services Apple identifiés pour comprendre leur configuration.

```bash
# Résolution détaillée des services mDNS
resolve_mdns_service() {
    local service_type=$1
    echo "=== Résolution $service_type ==="
    
    # Découverte des instances
    dns-sd -B $service_type local. | while read line; do
        if [[ $line == *"ADD"* ]]; then
            service_name=$(echo $line | awk -F' ' '{for(i=4;i<=NF;i++) printf "%s ", $i}' | sed 's/ $//')
            echo "Service trouvé: $service_name"
            
            # Résolution détaillée
            timeout 5 dns-sd -L "$service_name" $service_type local.
        fi
    done
}

# Résolution des services critiques
resolve_mdns_service "_afpovertcp._tcp"
resolve_mdns_service "_airplay._tcp"
resolve_mdns_service "_printer._tcp"
```

#### Étape 6 : Documentation et analyse des résultats

Consolidez toutes les informations collectées pour créer une cartographie de l'environnement Apple.

```bash
# Génération d'un rapport de découverte
cat > apple_network_report.txt << EOF
=== Rapport de Reconnaissance Réseau Apple ===
Date: $(date)
Réseau local: $(route -n get default | grep interface | awk '{print $2}')

=== Dispositifs découverts ===
EOF

# Ajout des informations ARP
echo "=== Table ARP ===" >> apple_network_report.txt
arp -a >> apple_network_report.txt

# Ajout des services Bonjour
echo -e "\n=== Services Bonjour découverts ===" >> apple_network_report.txt
timeout 30 dns-sd -B _services._dns-sd._udp local. >> apple_network_report.txt

echo "Rapport sauvegardé dans apple_network_report.txt"
```

### 4 • OPSEC Tips

#### 4.1 Utilisation discrète des protocoles Apple natifs

Les protocoles mDNS et Bonjour génèrent un trafic réseau légitime constant sur les réseaux Apple. Votre activité de reconnaissance utilisant dns-sd et les requêtes mDNS se fond naturellement dans ce trafic normal, rendant la détection difficile. Exploitez cette caractéristique en privilégiant les outils natifs macOS pour les phases initiales de découverte.

Évitez les scans agressifs qui pourraient saturer le trafic mDNS et attirer l'attention. Les requêtes Bonjour légitimes sont espacées et ciblées, imitez ce comportement en introduisant des délais naturels entre vos énumérations de services.

#### 4.2 Gestion des logs système macOS

macOS enregistre les activités réseau dans plusieurs fichiers de logs (/var/log/system.log, Console.app). Les requêtes DNS et les connexions réseau génèrent des entrées traçables. Surveillez vos propres logs pendant les tests pour comprendre les traces laissées par vos outils de reconnaissance.

```bash
# Surveillance des logs réseau en temps réel
log stream --predicate 'category == "network"' --level debug
```

Les outils comme nmap génèrent plus de traces que les utilitaires natifs. Utilisez-les avec parcimonie et privilégiez les techniques passives quand possible. La commande `log` permet de surveiller en temps réel les événements système pour adapter votre stratégie.

#### 4.3 Respect de l'écosystème Apple et des permissions

macOS implémente des contrôles de sécurité stricts qui peuvent bloquer certaines opérations de reconnaissance. Le System Integrity Protection (SIP) et les permissions d'application limitent l'accès aux ressources réseau. Travaillez dans le cadre de ces limitations plutôt que de tenter de les contourner, ce qui pourrait déclencher des alertes.

```bash
# Vérification du statut SIP
csrutil status
```

Utilisez les APIs et outils officiels Apple quand possible. Cette approche maintient la compatibilité avec les mécanismes de sécurité et réduit la probabilité de détection par les solutions de sécurité tierces qui surveillent les comportements anormaux.

### 5 • Lab-Challenge

#### Scénario : Audit de sécurité d'un environnement Apple d'entreprise

Vous êtes consultant en cybersécurité mandaté pour évaluer la sécurité d'un environnement Apple d'entreprise créative (studio de design). L'infrastructure comprend des Mac Studio, MacBook Pro, iPad Pro, Apple TV, imprimantes AirPrint et un serveur macOS gérant les partages AFP. L'entreprise utilise massivement AirDrop, AirPlay et les services de collaboration Apple.

Votre accès initial se fait depuis un MacBook Air connecté au réseau Wi-Fi invité de l'entreprise. L'objectif est d'identifier les dispositifs Apple, cartographier les services exposés et évaluer les risques de sécurité spécifiques à l'écosystème Apple sans perturber les activités créatives en cours.

#### ⚑ Étape 1 : Découverte de l'écosystème Apple

**Objectif :** Cartographier tous les dispositifs Apple et leurs services sans utiliser d'outils tiers.

**Questions :**
1. Utilisez uniquement dns-sd pour découvrir tous les services Bonjour disponibles sur le réseau.
2. Identifiez au moins 3 Apple TV et leurs capacités AirPlay respectives.
3. Découvrez toutes les imprimantes AirPrint et leurs modèles exacts.
4. Localisez les serveurs AFP et analysez leurs configurations de partage.

**Contraintes :**
- Utilisez uniquement les outils natifs macOS (dns-sd, arp, ping, netstat)
- Documentez chaque service découvert avec ses détails complets
- Évitez tout scan actif qui pourrait perturber les flux de travail créatifs

#### ⚑ Étape 2 : Analyse des services de collaboration Apple

**Objectif :** Évaluer la sécurité des services de collaboration et de partage Apple.

**Questions :**
1. Identifiez tous les dispositifs avec AirDrop activé et évaluez leurs configurations de visibilité.
2. Analysez les services de streaming AirPlay pour identifier les sessions actives.
3. Testez l'accès aux partages AFP sans authentification.
4. Découvrez les services iTunes/Music partagés et leurs bibliothèques accessibles.

**Contraintes :**
- Utilisez Nmap uniquement pour les ports Apple spécifiques (548, 5353, 62078)
- Testez la connectivité sans tenter d'accès non autorisé
- Documentez les configurations de sécurité observées

#### ⚑ Étape 3 : Évaluation de la surface d'attaque Apple

**Objectif :** Identifier les vulnérabilités et risques spécifiques à l'environnement Apple.

**Questions :**
1. Évaluez les risques liés aux services mDNS exposés publiquement.
2. Identifiez les dispositifs avec des services non sécurisés (HTTP vs HTTPS).
3. Analysez les patterns de nommage des dispositifs pour identifier les informations sensibles.
4. **Bonus stealth :** Effectuez toute l'analyse en utilisant uniquement le trafic mDNS passif.

**Livrables attendus :**
- Cartographie complète de l'écosystème Apple avec tous les dispositifs et services
- Analyse de sécurité des configurations Bonjour et mDNS
- Rapport de vulnérabilités spécifiques aux services Apple
- Recommandations de durcissement pour l'environnement Apple d'entreprise

### 6 • Going Further

#### Ressources officielles Apple et documentation

**Apple Network Services Documentation** - https://developer.apple.com/library/archive/documentation/Networking/Conceptual/NSNetServiceProgGuide/
Documentation officielle Apple sur les services réseau et l'implémentation de Bonjour/mDNS.

**macOS Security Compliance Project** - https://github.com/usnistgov/macos_security
Projet NIST fournissant des guides de sécurisation macOS avec configurations recommandées pour les environnements d'entreprise.

**Apple Platform Security Guide** - https://support.apple.com/guide/security/
Guide officiel Apple détaillant les mécanismes de sécurité intégrés dans macOS et iOS.

#### Ressources d'apprentissage spécialisées macOS

**"macOS Security and Privacy Guide" par drduh**
Guide communautaire complet pour la sécurisation de macOS avec focus sur la configuration réseau et la protection de la vie privée.

**"Apple Device Management" par Charles Edge**
Référence technique sur la gestion des dispositifs Apple en entreprise incluant les aspects de sécurité réseau.

**Chaîne YouTube "Mac Admin Info"** - https://www.youtube.com/c/MacAdminInfo
Ressources techniques pour l'administration macOS avec tutoriels sur la sécurité réseau et la gestion des services.

**Cours "macOS Support Essentials" d'Apple**
Formation officielle Apple couvrant l'administration système macOS incluant la configuration réseau et la sécurité.

#### Certifications et spécialisations Apple

**Apple Certified Support Professional (ACSP)**
Certification officielle Apple validant les compétences d'administration macOS incluant la gestion réseau et la sécurité.

**JAMF Certified Admin**
Certification spécialisée dans la gestion des dispositifs Apple en entreprise avec modules sur la sécurité et le monitoring réseau.

**GIAC Mac Forensics (GMOB)**
Certification SANS spécialisée dans l'investigation forensique sur les systèmes Apple incluant l'analyse des artefacts réseau.

