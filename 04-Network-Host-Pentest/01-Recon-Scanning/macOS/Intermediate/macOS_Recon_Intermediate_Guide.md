# macOS Recon-Scanning – Intermediate

La reconnaissance réseau intermédiaire sous macOS exploite des techniques avancées d'énumération Bonjour, d'analyse des protocoles Apple propriétaires et de découverte de services AFP/SMB. Ce guide couvre l'utilisation de Nmap avec des scripts spécialisés pour macOS, l'analyse approfondie des services mDNS, et les techniques d'énumération des infrastructures Apple complexes incluant les environnements hybrides macOS/iOS.

## Table of Contents
1. Concepts clés
2. Outils & Commandes
3. Méthode pas-à-pas
4. OPSEC Tips
5. Lab-Challenge
6. Going Further

---

### 1 • Concepts clés

#### 1.1 Architecture réseau Apple avancée et intégration cloud

Les environnements Apple d'entreprise intègrent des services cloud hybrides combinant infrastructure locale et services iCloud. Cette architecture nécessite une compréhension approfondie des flux de données entre dispositifs locaux et services Apple distants. L'analyse de ces patterns révèle l'architecture de sécurité et les points de contrôle critiques.

#### 1.2 Protocoles AFP, SMB et services de fichiers Apple

L'énumération avancée des services de fichiers Apple nécessite la maîtrise des protocoles AFP (Apple Filing Protocol) et de leur intégration avec SMB. Ces protocoles exposent des métadonnées riches sur l'organisation des données et les permissions d'accès, permettant une cartographie précise des ressources sensibles.

#### 1.3 Analyse comportementale des dispositifs iOS et macOS

Les dispositifs Apple présentent des patterns de comportement réseau spécifiques liés à leurs cycles de synchronisation, mises à jour automatiques et communications inter-dispositifs. L'analyse de ces patterns permet d'identifier les types de dispositifs, leurs configurations et leurs relations dans l'écosystème Apple.

#### 1.4 Sécurité des services Bonjour et vulnérabilités mDNS

Les implémentations Bonjour peuvent présenter des vulnérabilités spécifiques permettant l'énumération d'informations sensibles ou l'exploitation de services mal configurés. L'analyse approfondie des annonces mDNS révèle souvent des informations non intentionnellement exposées sur l'infrastructure interne.

### 2 • Outils & Commandes

#### Tableau comparatif des outils macOS intermédiaires

| Outil | Spécialisation | Complexité | Efficacité | Discrétion |
|-------|----------------|------------|------------|------------|
| nmap + NSE | Scan Apple avancé | Moyenne | Très élevée | Moyenne |
| dns-sd avancé | Énumération mDNS | Moyenne | Élevée | Très élevée |
| smbclient | Énumération SMB | Faible | Élevée | Élevée |
| afpfuse | Montage AFP | Moyenne | Élevée | Moyenne |
| tcpdump | Analyse trafic | Élevée | Très élevée | Très élevée |
| wireshark | Analyse protocolaire | Élevée | Très élevée | Élevée |

#### Scripts Nmap spécialisés pour macOS

```bash
# Énumération complète des services Apple
nmap --script apple-* -p 548,5353,62078 192.168.1.0/24

# Détection spécifique des services AFP
nmap --script afp-ls,afp-path-vuln,afp-serverinfo -p 548 TARGET

# Énumération des services Bonjour via Nmap
nmap --script dns-service-discovery -p 5353 TARGET

# Détection des dispositifs AirPlay
nmap --script http-title,http-headers -p 62078 TARGET
```

#### Énumération AFP et SMB avancée

```bash
# Connexion et énumération AFP
smbclient -L //TARGET -N
smbclient //TARGET/share -N -c "ls"

# Montage AFP pour analyse
mkdir /tmp/afp_mount
mount_afp afp://guest@TARGET/share /tmp/afp_mount

# Énumération des métadonnées AFP
afpfuse TARGET /tmp/afp_mount -o allow_other
ls -la /tmp/afp_mount
```

#### Analyse avancée du trafic mDNS

```bash
# Capture du trafic mDNS
sudo tcpdump -i en0 -n port 5353 -w mdns_capture.pcap

# Analyse des annonces Bonjour
tcpdump -r mdns_capture.pcap -n | grep -E "(PTR|SRV|TXT)"

# Énumération passive des services
sudo tcpdump -i en0 -n port 5353 | while read line; do
    echo "$line" | grep -E "_.*\._tcp|_.*\._udp" && echo "Service détecté: $line"
done
```

### 3 • Méthode pas-à-pas

#### Étape 1 : Reconnaissance passive avancée

```bash
# Surveillance passive du trafic mDNS
sudo tcpdump -i en0 -n port 5353 -c 100 | tee mdns_traffic.log

# Analyse des patterns de trafic Apple
netstat -i 1 | while read line; do
    echo "$(date): $line" >> network_activity.log
done &
```

#### Étape 2 : Énumération Bonjour sophistiquée

```bash
# Découverte exhaustive des services
for service in $(dns-sd -B _services._dns-sd._udp local. | grep ADD | awk '{print $4}'); do
    echo "=== Énumération $service ==="
    timeout 30 dns-sd -B $service local.
done

# Résolution complète des instances
dns-sd -B _afpovertcp._tcp local. | while read line; do
    if [[ $line == *"ADD"* ]]; then
        service_name=$(echo $line | cut -d' ' -f4-)
        dns-sd -L "$service_name" _afpovertcp._tcp local.
    fi
done
```

#### Étape 3 : Scan de ports Apple ciblé

```bash
# Scan optimisé pour les services Apple
nmap -sV -sC -p 22,80,443,548,5353,62078,88,389,636,3283,5009 192.168.1.0/24 -oA apple_services

# Énumération spécialisée par service
nmap --script afp-serverinfo,afp-showmount -p 548 192.168.1.0/24
nmap --script dns-service-discovery -pU 5353 192.168.1.0/24
```

### 4 • OPSEC Tips

#### 4.1 Exploitation du trafic mDNS légitime

Le trafic mDNS constant sur les réseaux Apple masque efficacement les activités de reconnaissance. Synchronisez vos requêtes avec les patterns naturels de découverte de services pour maintenir la discrétion.

#### 4.2 Gestion des timeouts et de la persistance

Les services Apple peuvent avoir des temps de réponse variables. Implémentez des timeouts adaptatifs et des mécanismes de retry pour éviter les faux négatifs tout en maintenant la discrétion.

#### 4.3 Corrélation avec les cycles de synchronisation

Les dispositifs Apple synchronisent régulièrement avec iCloud. Planifiez vos activités de reconnaissance pendant ces fenêtres pour masquer votre trafic dans les communications légitimes.

### 5 • Lab-Challenge

#### Scénario : Audit d'une infrastructure Apple d'entreprise créative

Vous évaluez la sécurité d'un studio de production multimédia utilisant une infrastructure Apple complexe : Mac Pro, iPad Pro, Apple TV 4K, serveurs macOS et stockage réseau AFP. L'environnement intègre des workflows créatifs avec partage de fichiers volumineux et streaming temps réel.

#### ⚑ Étape 1 : Cartographie de l'écosystème créatif

**Questions :**
1. Identifiez tous les serveurs AFP et analysez leurs configurations de partage.
2. Découvrez les dispositifs AirPlay et leurs capacités de streaming.
3. Cartographiez les flux de synchronisation iCloud actifs.
4. Analysez les services de collaboration temps réel.

#### ⚑ Étape 2 : Énumération des services de production

**Questions :**
1. Identifiez les services de rendu et de traitement vidéo.
2. Découvrez les systèmes de stockage réseau et leurs capacités.
3. Analysez les configurations de sécurité des partages créatifs.
4. Évaluez l'exposition des métadonnées de projets.

#### ⚑ Étape 3 : Analyse de sécurité spécialisée

**Questions :**
1. Identifiez les vulnérabilités dans les configurations AFP/SMB.
2. Analysez les risques liés aux services de streaming non sécurisés.
3. Évaluez l'exposition des données créatives sensibles.
4. **Bonus :** Développez des techniques de reconnaissance spécifiques aux workflows créatifs.

### 6 • Going Further

#### Ressources spécialisées Apple Enterprise

**Apple Deployment Reference** - https://support.apple.com/business/
Documentation officielle pour le déploiement Apple en entreprise avec guides de sécurité réseau.

**macOS Server Administration** - https://support.apple.com/macos-server/
Guides d'administration pour les services serveur macOS incluant AFP, SMB et services réseau.

#### Certifications avancées

**Apple Certified Technical Coordinator**
Certification avancée pour la gestion d'infrastructures Apple complexes.

**JAMF Certified Expert**
Spécialisation dans la gestion de sécurité des environnements Apple d'entreprise.

